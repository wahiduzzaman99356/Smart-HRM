<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>HRIS — Organogram</title>
<style>
/* ─── Reset & Base ───────────────────────────────────────── */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#eef1f7;--surface:#fff;
  --primary:#1a4fa0;--primary-dk:#113578;--primary-lt:#dce8f8;
  --accent:#e9a800;--danger:#c8281c;--success:#167040;
  --text:#1c1e26;--muted:#687080;--border:#d0d5de;
  --shadow:0 2px 10px rgba(0,0,0,.09);
}
html,body{height:100%;font-family:'Segoe UI',system-ui,sans-serif;font-size:14px;
  background:var(--bg);color:var(--text)}
button{cursor:pointer;font-family:inherit}
select,input{font-family:inherit;font-size:13px}

/* ─── App Shell ──────────────────────────────────────────── */
#app{display:flex;flex-direction:column;height:100vh;overflow:hidden}

/* ─── Top Bar ────────────────────────────────────────────── */
#topbar{
  background:linear-gradient(135deg,#1a4fa0 0%,#12367a 100%);
  color:#fff;height:54px;flex-shrink:0;
  display:flex;align-items:center;justify-content:space-between;
  padding:0 24px;box-shadow:0 2px 10px rgba(0,0,0,.25);z-index:10;
}
#topbar .brand{display:flex;flex-direction:column;gap:1px}
#topbar h1{font-size:17px;font-weight:700;letter-spacing:.2px}
#topbar .subtitle{font-size:11px;opacity:.7}
#topbar .tip{font-size:11.5px;opacity:.8}

/* ─── Toolbar ────────────────────────────────────────────── */
#toolbar{
  background:var(--surface);border-bottom:1px solid var(--border);
  padding:7px 20px;display:flex;align-items:center;gap:10px;flex-shrink:0;
}
.tb-btn{
  padding:5px 14px;border-radius:7px;border:1.5px solid var(--border);
  background:var(--surface);font-size:12px;font-weight:600;color:var(--text);
  transition:background .14s;
}
.tb-btn:hover{background:#eef1f7}
.tb-btn.danger-btn{border-color:#f0b0ab;color:var(--danger)}
.tb-btn.danger-btn:hover{background:#fee9e7}
#node-count{font-size:12px;color:var(--muted);margin-left:4px}

/* ─── Canvas ─────────────────────────────────────────────── */
#canvas-wrap{
  flex:1;overflow:auto;position:relative;background:var(--bg);
  background-image:radial-gradient(circle,#c8d0e0 1px,transparent 1px);
  background-size:28px 28px;
  cursor:grab;
}
#canvas-wrap.panning{cursor:grabbing}
#chart-inner{
  position:relative;
  transform-origin:0 0;
  display:inline-block;
  min-width:100vw;min-height:calc(100vh - 110px);
  padding:60px;
}
#svg-lines{
  position:absolute;top:0;left:0;
  width:100%;height:100%;
  pointer-events:none;overflow:visible;
}

/* ─── Node Card ──────────────────────────────────────────── */
.org-node{
  position:absolute;width:224px;
  background:var(--surface);
  border:1.5px solid var(--border);
  border-radius:12px;
  box-shadow:var(--shadow);
  display:flex;flex-direction:column;
  transition:box-shadow .18s,border-color .18s,transform .12s;
  overflow:hidden;
  user-select:none;
}
.org-node:hover{
  box-shadow:0 6px 22px rgba(0,0,0,.14);
  border-color:#a8b8cc;
  transform:translateY(-2px);
}
.org-node.is-root{border-color:var(--accent);border-width:2px}
.org-node.is-root .n-header{background:linear-gradient(135deg,#c27800,#e9a800)}
.org-node.is-empty .n-body{opacity:.55}

.n-header{
  background:linear-gradient(135deg,var(--primary),var(--primary-dk));
  color:#fff;padding:6px 11px;
  font-size:10.5px;font-weight:700;letter-spacing:.6px;text-transform:uppercase;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  display:flex;align-items:center;gap:6px;
}
.n-root-crown{font-size:13px;flex-shrink:0}

.n-body{padding:8px 11px;flex:1;min-height:56px}
.n-desig{font-size:12px;font-weight:700;color:var(--primary);line-height:1.3;margin-bottom:5px}
.n-empty-hint{font-size:11.5px;color:var(--muted);font-style:italic}
.n-emp{font-size:12.5px;font-weight:500;color:var(--text);line-height:1.2}
.n-empid{font-size:11px;color:var(--muted);margin-bottom:3px}
.n-more{font-size:11px;color:var(--primary);cursor:pointer;font-weight:600;margin-top:2px}

.n-footer{
  display:flex;gap:5px;padding:6px 10px;
  border-top:1px solid var(--border);background:#f8f9fc;
}
.n-btn{
  flex:1;padding:4px 0;border:none;border-radius:6px;
  font-size:11px;font-weight:700;letter-spacing:.3px;
  transition:background .13s,color .13s;
}
.n-btn-edit{background:var(--primary-lt);color:var(--primary)}
.n-btn-edit:hover{background:#c0d3ee}
.n-btn-add{background:#dff0e8;color:var(--success)}
.n-btn-add:hover{background:#bce2d0}
.n-btn-del{background:#fde8e6;color:var(--danger)}
.n-btn-del:hover{background:#fbcbc8}

.n-collapse-btn{
  text-align:center;padding:3px;font-size:10.5px;
  background:#f3f6fb;border-top:1px solid var(--border);
  color:var(--primary);cursor:pointer;font-weight:600;letter-spacing:.2px;
}
.n-collapse-btn:hover{background:var(--primary-lt)}

/* ─── Modal ──────────────────────────────────────────────── */
.modal-bg{
  display:none;position:fixed;inset:0;
  background:rgba(8,18,40,.55);backdrop-filter:blur(2px);
  z-index:80;align-items:center;justify-content:center;
}
.modal-bg.open{display:flex}
.modal-box{
  background:var(--surface);border-radius:16px;
  width:540px;max-width:96vw;max-height:92vh;
  display:flex;flex-direction:column;
  box-shadow:0 12px 48px rgba(0,0,0,.32);
  animation:popIn .18s ease;
}
@keyframes popIn{from{transform:scale(.94);opacity:0}to{transform:scale(1);opacity:1}}
.modal-hdr{
  padding:18px 22px;border-bottom:1px solid var(--border);
  display:flex;justify-content:space-between;align-items:center;
  flex-shrink:0;
}
.modal-hdr h2{font-size:15px;font-weight:700;color:var(--primary)}
.modal-x{background:none;border:none;font-size:22px;color:var(--muted);padding:0 4px;line-height:1}
.modal-x:hover{color:var(--danger)}
.modal-body{padding:18px 22px;overflow-y:auto;flex:1;display:flex;flex-direction:column;gap:15px}
.modal-ftr{
  padding:13px 22px;border-top:1px solid var(--border);
  display:flex;justify-content:flex-end;gap:10px;flex-shrink:0;
}

/* Form */
.fg{display:flex;flex-direction:column;gap:6px}
.fl{font-size:11.5px;font-weight:700;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
.fl .req{color:var(--danger);margin-left:2px}
.fsel{
  width:100%;padding:9px 32px 9px 12px;
  border:1.5px solid var(--border);border-radius:8px;
  background:var(--surface);color:var(--text);outline:none;
  transition:border-color .14s;
  appearance:none;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='11' height='7'%3E%3Cpath d='M.5.5l5 5 5-5' stroke='%23687080' stroke-width='1.4' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
  background-repeat:no-repeat;background-position:right 11px center;
}
.fsel:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(26,79,160,.11)}
.fsel:disabled{background:#f2f4f8;color:var(--muted);cursor:not-allowed}

/* Mode tabs */
.mode-tabs{display:flex;background:var(--bg);border-radius:10px;padding:3px;gap:3px}
.m-tab{
  flex:1;padding:8px;border:none;border-radius:7px;
  font-size:12.5px;font-weight:700;color:var(--muted);background:none;
  transition:background .13s,color .13s;
}
.m-tab.on{background:var(--primary);color:#fff;box-shadow:0 2px 8px rgba(26,79,160,.28)}

/* Employee checkbox list */
.emp-box{
  border:1.5px solid var(--border);border-radius:8px;
  max-height:168px;overflow-y:auto;
  background:var(--surface);
}
.emp-all{
  display:flex;align-items:center;gap:8px;
  padding:7px 10px;border-bottom:1px solid var(--border);
  background:#fafbfd;
}
.emp-all label{font-size:12px;font-weight:700;color:var(--primary);cursor:pointer}
.emp-row{
  display:flex;align-items:center;gap:8px;
  padding:6px 10px;cursor:pointer;
  transition:background .1s;
}
.emp-row:hover{background:var(--primary-lt)}
.emp-row span{font-size:12.5px;color:var(--text);cursor:pointer;flex:1;user-select:none}
.emp-row input,
.emp-all input{accent-color:var(--primary);width:15px;height:15px;flex-shrink:0;cursor:pointer}
.emp-empty{font-size:12px;color:var(--muted);padding:14px;text-align:center}

/* Info banner inside modal */
.info-banner{
  background:var(--primary-lt);border:1px solid #a8c0e0;border-radius:8px;
  padding:9px 13px;font-size:12.5px;color:var(--primary);
  display:flex;align-items:flex-start;gap:8px;
}
.info-banner svg{flex-shrink:0;margin-top:1px}

/* Validation msg */
.v-msg{
  padding:8px 12px;border-radius:8px;font-size:12.5px;font-weight:500;
  display:none;
}
.v-msg.err{background:#fee2e2;color:var(--danger);border:1px solid #fbaaaa;display:block}

/* Buttons */
.btn-pri{
  padding:9px 22px;background:var(--primary);color:#fff;
  border:none;border-radius:8px;font-size:13px;font-weight:700;
  transition:background .14s;
}
.btn-pri:hover{background:var(--primary-dk)}
.btn-pri:disabled{background:#9aadca;cursor:not-allowed}
.btn-sec{
  padding:9px 18px;background:var(--bg);color:var(--text);
  border:1.5px solid var(--border);border-radius:8px;font-size:13px;font-weight:600;
  transition:background .14s;
}
.btn-sec:hover{background:#e2e6ee}

/* ─── Confirm dialog ─────────────────────────────────────── */
#confirm-bg{
  display:none;position:fixed;inset:0;
  background:rgba(8,18,40,.55);z-index:200;
  align-items:center;justify-content:center;
}
#confirm-bg.open{display:flex}
.confirm-box{
  background:var(--surface);border-radius:14px;
  width:360px;padding:26px 22px;
  box-shadow:0 8px 36px rgba(0,0,0,.28);
}
.confirm-title{font-size:15px;font-weight:700;color:var(--danger);margin-bottom:10px}
.confirm-body{font-size:13px;color:var(--text);line-height:1.55;margin-bottom:20px}
.confirm-foot{display:flex;gap:10px;justify-content:flex-end}

/* ─── Zoom controls ──────────────────────────────────────── */
#zoom-bar{
  position:fixed;bottom:20px;right:22px;z-index:50;
  background:var(--surface);border:1px solid var(--border);
  border-radius:12px;padding:7px 12px;
  display:flex;align-items:center;gap:8px;
  box-shadow:var(--shadow);
}
.z-btn{
  background:var(--bg);border:1px solid var(--border);
  border-radius:6px;padding:1px 9px;font-size:16px;font-weight:700;
  color:var(--text);line-height:1.5;
}
.z-btn:hover{background:#dde3ef}
#z-pct{font-size:12px;font-weight:700;color:var(--primary);min-width:38px;text-align:center}

/* Scrollbar */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:#f0f2f7}
::-webkit-scrollbar-thumb{background:#bbc4d4;border-radius:4px}
::-webkit-scrollbar-thumb:hover{background:#9aaac0}
</style>
</head>
<body>
<div id="app">

  <!-- ── TOP BAR ────────────────────────────────────────────── -->
  <div id="topbar">
    <div class="brand">
      <h1>Organizational Chart</h1>
      <div class="subtitle">Human Resource Information System</div>
    </div>
    <div class="tip">Click <b>Edit</b> on a node to assign&nbsp;&nbsp;|&nbsp;&nbsp;Click <b>+ Add</b> to add a child node</div>
  </div>

  <!-- ── TOOLBAR ────────────────────────────────────────────── -->
  <div id="toolbar">
    <button class="tb-btn danger-btn" id="btn-reset">↺ Reset</button>
    <button class="tb-btn" id="btn-expand">⊞ Expand All</button>
    <button class="tb-btn" id="btn-collapse">⊟ Collapse All</button>
    <button class="tb-btn" id="btn-fit">⛶ Fit View</button>
    <span id="node-count"></span>
  </div>

  <!-- ── CANVAS ─────────────────────────────────────────────── -->
  <div id="canvas-wrap">
    <div id="chart-inner">
      <svg id="svg-lines"></svg>
    </div>
  </div>
</div>

<!-- ── ZOOM BAR ─────────────────────────────────────────────── -->
<div id="zoom-bar">
  <button class="z-btn" id="z-out">−</button>
  <span id="z-pct">100%</span>
  <button class="z-btn" id="z-in">+</button>
</div>

<!-- ══════════════════════════════════════════════════════════
     ASSIGNMENT MODAL
══════════════════════════════════════════════════════════ -->
<div class="modal-bg" id="modal-bg">
<div class="modal-box" id="modal-box">
  <div class="modal-hdr">
    <h2 id="modal-title">Assign Node</h2>
    <button class="modal-x" id="modal-x">×</button>
  </div>
  <div class="modal-body">

    <!-- Root-node notice -->
    <div class="info-banner" id="root-note" style="display:none">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
        <circle cx="8" cy="8" r="7.5" stroke="#1a4fa0" stroke-width="1.5"/>
        <path d="M8 7v4.5M8 4.5v1" stroke="#1a4fa0" stroke-width="1.5" stroke-linecap="round"/>
      </svg>
      <span>This is the <strong>Root Node</strong> — the highest authority. It has no "Reporting To" field.</span>
    </div>

    <!-- Assignment mode toggle -->
    <div class="fg" id="mode-grp">
      <div class="fl">Assignment Mode</div>
      <div class="mode-tabs">
        <button class="m-tab on" id="tab-des" onclick="setMode('designation')">Designation-Based</button>
        <button class="m-tab"    id="tab-spe" onclick="setMode('specific')">Specific Employee</button>
      </div>
    </div>

    <!-- ── DESIGNATION MODE ── -->
    <div id="sec-des">
      <div class="fg">
        <div class="fl">Department<span class="req">*</span></div>
        <select class="fsel" id="s-dept" onchange="onDeptChange()">
          <option value="">— Select Department —</option>
        </select>
      </div>
      <div class="fg" style="margin-top:14px">
        <div class="fl">Designation<span class="req">*</span></div>
        <select class="fsel" id="s-desig" onchange="onDesigChange()" disabled>
          <option value="">— Select Designation —</option>
        </select>
      </div>
      <div class="fg" id="emp-grp" style="display:none;margin-top:14px">
        <div class="fl">Select Employee(s)<span class="req">*</span></div>
        <div class="emp-box" id="emp-box">
          <div class="emp-empty">Choose a designation to load employees</div>
        </div>
      </div>
    </div>

    <!-- ── SPECIFIC EMPLOYEE MODE ── -->
    <div id="sec-spe" style="display:none">
      <div class="fg">
        <div class="fl">Employee<span class="req">*</span></div>
        <select class="fsel" id="s-emp-spe" onchange="onSpeEmpChange()">
          <option value="">— Select Employee —</option>
        </select>
      </div>
      <div id="spe-detail" style="display:none;margin-top:10px">
        <div class="info-banner">
          <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
            <circle cx="7" cy="7" r="6.5" stroke="#1a4fa0" stroke-width="1.3"/>
            <path d="M7 6.3V10M7 4v1" stroke="#1a4fa0" stroke-width="1.3" stroke-linecap="round"/>
          </svg>
          <span><b>Dept:</b> <span id="spe-dept"></span>&emsp;<b>Designation:</b> <span id="spe-desig"></span></span>
        </div>
      </div>
    </div>

    <!-- Reporting To (hidden for root) -->
    <div class="fg" id="rep-grp" style="margin-top:2px">
      <div class="fl">Reporting To<span class="req">*</span></div>
      <select class="fsel" id="s-rep" onchange="onRepChange()">
        <option value="">— Select Reporting Person —</option>
      </select>
      <div style="font-size:11.5px;color:var(--muted);margin-top:3px">
        Employees currently present in the organogram
      </div>
    </div>

    <div class="v-msg" id="v-msg"></div>

  </div>
  <div class="modal-ftr">
    <button class="btn-sec" onclick="closeModal()">Cancel</button>
    <button class="btn-pri" id="modal-save" onclick="saveNode()" disabled>Save</button>
  </div>
</div>
</div>

<!-- ══════════════════════════════════════════════════════════
     CONFIRM DIALOG
══════════════════════════════════════════════════════════ -->
<div id="confirm-bg">
<div class="confirm-box">
  <div class="confirm-title" id="cf-title">Confirm Delete</div>
  <div class="confirm-body" id="cf-body"></div>
  <div class="confirm-foot">
    <button class="btn-sec" onclick="closeConfirm()">Cancel</button>
    <button class="btn-pri" id="cf-ok" style="background:var(--danger)">Delete</button>
  </div>
</div>
</div>

<script>
/* ═══════════════════════════════════════════════════════════
   MASTER: DEPARTMENT → DESIGNATIONS
═══════════════════════════════════════════════════════════ */
const DEPT_MAP = {
  "Higher Management":[
    "CEO & Accountable Manager"
  ],
  "Flight Operations":[
    "Director Flight Operations","Chief of Training","Chief of Safety","Chief of Technical",
    "Captain ATR 72-600","First Officer ATR 72-600",
    "Deputy General Manager, Flight Operations","Manager, Flight Operations",
    "Assistant Manager, OCC","Senior Flight Operations Officer","Flight Operations Officer",
    "Executive, Training","Executive, Training & Crew Scheduling",
    "Executive, Technical","Executive, Operations Engineering"
  ],
  "Safety":[
    "Deputy Manager, Flight Data Monitoring & IT","Executive, Flight Data Analyst"
  ],
  "Corporate Quality & SMS":[
    "Auditor"
  ],
  "Cabin Service":[
    "Head of Cabin Safety & Service","Assistant Manager, Training",
    "Executive, Cabin Service","Executive, Admin & Scheduling",
    "Purser","Senior Cabin Crew (CIC)","Cabin in Charge (CIC)","Cabin Crew"
  ],
  "Engineering":[
    "Head of Engineering/CAMO","Technical Manager, Engineering & Reliability",
    "Technical Manager, Planning & Records","Maintenance Coordinator",
    "Maintenance Coordinator/Technician","Technical Executive, Planning & Records",
    "Technical Executive, Engineering & Reliability"
  ],
  "Quality Assurance":[
    "Head of Quality Assurance","Senior Technical Executive, Quality Assurance",
    "Technical Executive, Quality Assurance","Chief Financial Officer",
    "Assistant General Manager","Executive","Executive, Teller"
  ],
  "Revenue Accounts":[
    "Senior Manager, Revenue","Senior Executive, Revenue"
  ],
  "Marketing & Sales":[
    "Chief Commercial Officer","Deputy General Manager, Marketing & Sales",
    "Assistant Manager, Sales","Senior Executive","Executive"
  ],
  "Brand Marketing":[
    "Assistant General Manager, Brand Marketing",
    "Senior Visualizer, Brand Communication","Senior Executive, Brand Communication"
  ],
  "Public Relations":[
    "Deputy Manager, Public Relations"
  ],
  "Human Resources":[
    "Manager, Human Resources","Executive, Human Resources"
  ],
  "IT":[
    "Senior Executive, IT","Executive, IT"
  ],
  "Administration":[
    "General Manager, Administration & Airline Security",
    "Senior Executive, Local Procurement","Executive, Transport",
    "Executive, Front Desk","Executive, Admin",
    "Senior Office Assistant","Office Assistant","Office Cleaner",
    "Office Assistant Cum Cleaner","Motor Transport Operator (MTO)"
  ],
  "Airline Security":[
    "Deputy Manager","Senior Security Officer","Security Officer",
    "Executive, Security","Security Supervisor",
    "Assistant Security Supervisor","Security Assistant"
  ],
  "Catering":[
    "Executive, Catering","Catering Assistant"
  ],
  "Ground Operations":[
    "Head of Ground Operations & DGR","Deputy Station Manager",
    "Assistant Station Manager","Senior Executive","Executive",
    "Passenger Service Agent","Senior Traffic Helper",
    "Traffic Helper","Aircraft Cleaner"
  ]
};

/* ═══════════════════════════════════════════════════════════
   MOCK EMPLOYEE DATABASE
═══════════════════════════════════════════════════════════ */
const EMPLOYEES = (()=>{
  const first=[
    "Md. Wahiduzzaman","Farhana","Tanvir","Sadia","Rakibul","Nasreen",
    "Abdullah","Habiba","Imran","Kohinoor","Rezaul","Shahnaz",
    "Tariqul","Maliha","Ashraful","Dilruba","Kamruzzaman","Parvin",
    "Shafiqul","Yasmin","Abidur","Lubna","Nayeem","Roksana","Jahangir",
    "Mahfuza","Shariful","Tahmina","Belal","Shirin","Sabbir","Morshed"
  ];
  const last=[
    "Nayem","Islam","Khanam","Haque","Ahmed","Begum","Rahman",
    "Chowdhury","Bhuiyan","Akter","Hossain","Sultana","Khan",
    "Karim","Ullah","Roy","Sarker","Mondal","Sheikh","Molla"
  ];
  const pool=[];
  let ctr=99356;
  // deterministic pseudo-random
  let seed=42;
  function rnd(n){seed=(seed*1664525+1013904223)&0xffffffff;return((seed>>>0)%n);}
  for(const dept of Object.keys(DEPT_MAP)){
    for(const desig of DEPT_MAP[dept]){
      const cnt=rnd(3)+2; // 2–4
      for(let i=0;i<cnt;i++){
        pool.push({
          id:`TN-${ctr++}`,
          name:`${first[rnd(first.length)]} ${last[rnd(last.length)]}`,
          department:dept,
          designation:desig
        });
      }
    }
  }
  return pool;
})();

function empById(id){return EMPLOYEES.find(e=>e.id===id)||null;}
function empLabel(e){return `${e.name} (${e.id})`;}
function empsByDesig(dept,desig){return EMPLOYEES.filter(e=>e.department===dept&&e.designation===desig);}

/* ═══════════════════════════════════════════════════════════
   ORGANOGRAM STATE
═══════════════════════════════════════════════════════════ */
let _nc=0;
function uid(){return`n${++_nc}`;}

const S={
  nodes:{},    // id → node
  rootId:null,
  collapsed:new Set()
};

function mkNode(isRoot=false){
  return{id:uid(),isRoot,department:null,designation:null,
    employees:[],reportingTo:null,children:[]};
}

function initRoot(){
  _nc=0;
  const n=mkNode(true);
  S.nodes={[n.id]:n};
  S.rootId=n.id;
  S.collapsed.clear();
  return n.id;
}

function addChild(parentId){
  const n=mkNode(false);
  const par=S.nodes[parentId];
  if(!par)return null;
  n.reportingTo=parentId;
  par.children.push(n.id);
  S.nodes[n.id]=n;
  return n.id;
}

function removeNode(nodeId){
  const n=S.nodes[nodeId];
  if(!n||n.isRoot)return;
  for(const c of [...n.children])removeNode(c);
  const par=S.nodes[n.reportingTo];
  if(par)par.children=par.children.filter(x=>x!==nodeId);
  delete S.nodes[nodeId];
}

// All employees currently placed in the organogram
function orgEmps(excludeNodeId=null){
  const list=[];
  for(const node of Object.values(S.nodes)){
    if(node.id===excludeNodeId)continue;
    for(const e of node.employees)list.push({...e,_nid:node.id});
  }
  return list;
}

function nodeOfEmp(empId){
  return Object.values(S.nodes).find(n=>n.employees.some(e=>e.id===empId))||null;
}

// Hierarchy checks
function isAncestorOf(ancId,nodeId){
  let cur=S.nodes[nodeId];
  while(cur&&cur.reportingTo){
    if(cur.reportingTo===ancId)return true;
    cur=S.nodes[cur.reportingTo];
  }
  return false;
}
function isDescendantOf(descId,nodeId){return isAncestorOf(nodeId,descId);}

/* ═══════════════════════════════════════════════════════════
   TREE LAYOUT  (top-down, centred)
═══════════════════════════════════════════════════════════ */
const NW=224,NH=118,GX=48,GY=68,PAD=64;

function subW(id){
  const n=S.nodes[id];
  if(!n)return NW;
  const vis=n.children.filter(c=>S.nodes[c]);
  if(!vis.length||S.collapsed.has(id))return NW;
  const cw=vis.reduce((s,c)=>s+subW(c)+GX,0)-GX;
  return Math.max(NW,cw);
}

function layout(){
  if(!S.rootId)return{};
  const pos={};
  function place(id,x,y){
    const n=S.nodes[id];
    if(!n)return;
    pos[id]={x:x+subW(id)/2-NW/2, y};
    const vis=n.children.filter(c=>S.nodes[c]);
    if(!vis.length||S.collapsed.has(id))return;
    let cx=x;
    for(const c of vis){place(c,cx,y+NH+GY);cx+=subW(c)+GX;}
  }
  place(S.rootId,0,0);
  return pos;
}

/* ═══════════════════════════════════════════════════════════
   RENDERING
═══════════════════════════════════════════════════════════ */
function render(){
  const inner=document.getElementById('chart-inner');
  const svg=document.getElementById('svg-lines');
  // Clear nodes
  [...inner.children].forEach(el=>{if(el.id!=='svg-lines')el.remove();});
  svg.innerHTML='';

  const pos=layout();
  if(!Object.keys(pos).length)return;

  // Bounding box
  let mx=Infinity,my=Infinity,Mx=-Infinity,My=-Infinity;
  for(const{x,y}of Object.values(pos)){
    if(x<mx)mx=x;if(y<my)my=y;
    if(x+NW>Mx)Mx=x+NW;if(y+NH>My)My=y+NH;
  }
  const W=(Mx-mx)+PAD*2, H=(My-my)+PAD*2;
  inner.style.width=W+'px';
  inner.style.height=H+'px';
  svg.setAttribute('viewBox',`0 0 ${W} ${H}`);
  svg.style.width=W+'px';svg.style.height=H+'px';

  const ox=-mx+PAD, oy=-my+PAD;

  // SVG connector lines
  for(const[id,{x,y}]of Object.entries(pos)){
    const n=S.nodes[id];
    if(!n||!n.reportingTo)continue;
    const pp=pos[n.reportingTo];if(!pp)continue;
    const x1=x+NW/2+ox, y1=y+oy;
    const x2=pp.x+NW/2+ox, y2=pp.y+NH+oy;
    const midY=(y1+y2)/2;
    const path=document.createElementNS('http://www.w3.org/2000/svg','path');
    path.setAttribute('d',`M${x2},${y2} C${x2},${midY} ${x1},${midY} ${x1},${y1}`);
    path.setAttribute('fill','none');
    path.setAttribute('stroke','#94a3b8');
    path.setAttribute('stroke-width','2');
    svg.appendChild(path);
    // Arrow head
    const arr=document.createElementNS('http://www.w3.org/2000/svg','polygon');
    arr.setAttribute('points',`${x1-5},${y1+1} ${x1+5},${y1+1} ${x1},${y1-7}`);
    arr.setAttribute('fill','#94a3b8');
    svg.appendChild(arr);
  }

  // Nodes
  for(const[id,{x,y}]of Object.entries(pos)){
    const n=S.nodes[id];if(!n)continue;
    const hasKids=n.children.filter(c=>S.nodes[c]).length>0;
    const empty=n.employees.length===0;
    const el=document.createElement('div');
    el.className='org-node'+(n.isRoot?' is-root':'')+(empty?' is-empty':'');
    el.style.left=(x+ox)+'px';
    el.style.top=(y+oy)+'px';

    // Header
    const hdr=document.createElement('div');
    hdr.className='n-header';
    if(n.isRoot)hdr.innerHTML='<span class="n-root-crown">★</span>';
    hdr.innerHTML+=(n.department||'UNASSIGNED');
    el.appendChild(hdr);

    // Body
    const body=document.createElement('div');
    body.className='n-body';
    let bhtml=`<div class="n-desig">${n.designation||(empty?'No Designation Assigned':'')}</div>`;
    if(empty){
      bhtml+='<div class="n-empty-hint">Click Edit to assign</div>';
    }else{
      const show=Math.min(n.employees.length,2);
      for(let i=0;i<show;i++){
        const e=n.employees[i];
        bhtml+=`<div class="n-emp">${e.name}</div><div class="n-empid">${e.id}</div>`;
      }
      if(n.employees.length>2){
        bhtml+=`<div class="n-more">+${n.employees.length-2} more employee${n.employees.length-2>1?'s':''}</div>`;
      }
    }
    body.innerHTML=bhtml;
    el.appendChild(body);

    // Footer
    const foot=document.createElement('div');
    foot.className='n-footer';
    foot.innerHTML=`
      <button class="n-btn n-btn-edit" onclick="doEdit('${id}')">✎ Edit</button>
      <button class="n-btn n-btn-add"  onclick="doAdd('${id}')">+ Add</button>
      ${!n.isRoot?`<button class="n-btn n-btn-del" onclick="doDelete('${id}')">✕</button>`:''}
    `;
    el.appendChild(foot);

    // Collapse toggle
    if(hasKids){
      const tog=document.createElement('div');
      tog.className='n-collapse-btn';
      tog.textContent=S.collapsed.has(id)?'▼ Show Children':'▲ Hide Children';
      tog.onclick=()=>{
        S.collapsed.has(id)?S.collapsed.delete(id):S.collapsed.add(id);
        render();
      };
      el.appendChild(tog);
    }

    inner.appendChild(el);
  }
  updateCount();
}

function updateCount(){
  const total=Object.keys(S.nodes).length;
  const assigned=Object.values(S.nodes).filter(n=>n.employees.length>0).length;
  document.getElementById('node-count').textContent=
    `${total} node${total!==1?'s':''} · ${assigned} assigned`;
}

/* ═══════════════════════════════════════════════════════════
   MODAL STATE & LOGIC
═══════════════════════════════════════════════════════════ */
let M={
  nodeId:null,
  mode:'designation',   // 'designation' | 'specific'
  isAdd:false,
  defRepNodeId:null,    // default reporting node (from parent)
  dept:'',desig:'',
  selEmps:[],           // emp ids
  repEmpId:'',
  speEmpId:''
};

window.doEdit=function(nodeId){
  const n=S.nodes[nodeId];if(!n)return;
  M={nodeId,mode:'designation',isAdd:false,defRepNodeId:null,
    dept:n.department||'',desig:n.designation||'',
    selEmps:n.employees.map(e=>e.id),repEmpId:'',speEmpId:''};
  // pre-fill reporting
  if(n.reportingTo){
    const rn=S.nodes[n.reportingTo];
    if(rn&&rn.employees.length>0)M.repEmpId=rn.employees[0].id;
  }
  openModal();
};

window.doAdd=function(parentId){
  const childId=addChild(parentId);
  render();
  M={nodeId:childId,mode:'designation',isAdd:true,defRepNodeId:parentId,
    dept:'',desig:'',selEmps:[],repEmpId:'',speEmpId:''};
  // default reporting = parent's first employee
  const par=S.nodes[parentId];
  if(par&&par.employees.length>0)M.repEmpId=par.employees[0].id;
  openModal();
};

window.doDelete=function(nodeId){
  const n=S.nodes[nodeId];if(!n||n.isRoot)return;
  const dc=countDesc(nodeId);
  const nameStr=n.employees.length?n.employees.map(e=>e.name).join(', '):'this empty node';
  document.getElementById('cf-body').innerHTML=
    `Delete <b>${nameStr}</b>${dc>0?` and its <b>${dc} child node${dc>1?'s':''}</b>`:''}? This cannot be undone.`;
  document.getElementById('confirm-bg').classList.add('open');
  document.getElementById('cf-ok').onclick=()=>{
    removeNode(nodeId);closeConfirm();render();
  };
};

function countDesc(id,count=0){
  const n=S.nodes[id];if(!n)return count;
  for(const c of n.children) count=countDesc(c,count+1);
  return count;
}

window.closeConfirm=function(){document.getElementById('confirm-bg').classList.remove('open');};

function openModal(){
  const n=S.nodes[M.nodeId];
  document.getElementById('modal-title').textContent=
    M.isAdd?'Add Child Node':(n&&n.employees.length?'Edit Node':'Assign Node');
  document.getElementById('root-note').style.display=n&&n.isRoot?'flex':'none';
  document.getElementById('rep-grp').style.display=n&&n.isRoot?'none':'';
  document.getElementById('modal-bg').classList.add('open');
  setMode(M.mode);
}

window.closeModal=function(){
  document.getElementById('modal-bg').classList.remove('open');
  // if newly added + empty, remove it
  const n=S.nodes[M.nodeId];
  if(n&&M.isAdd&&n.employees.length===0){removeNode(M.nodeId);render();}
};

window.setMode=function(m){
  M.mode=m;
  document.getElementById('tab-des').classList.toggle('on',m==='designation');
  document.getElementById('tab-spe').classList.toggle('on',m==='specific');
  document.getElementById('sec-des').style.display=m==='designation'?'':'none';
  document.getElementById('sec-spe').style.display=m==='specific'?'':'none';
  if(m==='designation'){buildDeptSel();buildDesigSel();buildEmpBox();}
  else buildSpeSel();
  buildRepSel();
  validate();
};

function buildDeptSel(){
  const s=document.getElementById('s-dept');
  s.innerHTML='<option value="">— Select Department —</option>';
  for(const d of Object.keys(DEPT_MAP)){
    const o=document.createElement('option');
    o.value=d;o.textContent=d;
    if(d===M.dept)o.selected=true;
    s.appendChild(o);
  }
}

function buildDesigSel(){
  const s=document.getElementById('s-desig');
  s.innerHTML='<option value="">— Select Designation —</option>';
  if(!M.dept){s.disabled=true;return;}
  s.disabled=false;
  for(const d of(DEPT_MAP[M.dept]||[])){
    const o=document.createElement('option');
    o.value=d;o.textContent=d;
    if(d===M.desig)o.selected=true;
    s.appendChild(o);
  }
}

function buildEmpBox(){
  const grp=document.getElementById('emp-grp');
  const box=document.getElementById('emp-box');
  if(!M.dept||!M.desig){grp.style.display='none';return;}
  grp.style.display='';
  const taken=new Set(orgEmps(M.nodeId).map(e=>e.id));
  const all=empsByDesig(M.dept,M.desig);
  const avail=all.filter(e=>!taken.has(e.id));
  if(!avail.length){
    box.innerHTML='<div class="emp-empty">All employees under this designation are already placed in the chart</div>';
    return;
  }
  const allChk=M.selEmps.length===avail.length&&avail.length>0;
  let h=`<div class="emp-all">
    <input type="checkbox" id="chk-all" ${allChk?'checked':''} onchange="toggleAll(this.checked)">
    <label for="chk-all">Select All (${avail.length})</label>
  </div>`;
  for(const e of avail){
    const chk=M.selEmps.includes(e.id);
    h+=`<label class="emp-row">
      <input type="checkbox" value="${e.id}" ${chk?'checked':''} onchange="toggleEmp('${e.id}',this.checked)">
      <span>${empLabel(e)}</span>
    </label>`;
  }
  box.innerHTML=h;
}

function buildSpeSel(){
  const s=document.getElementById('s-emp-spe');
  s.innerHTML='<option value="">— Select Employee —</option>';
  const taken=new Set(orgEmps(M.nodeId).map(e=>e.id));
  const avail=EMPLOYEES.filter(e=>!taken.has(e.id));
  const byD={};
  for(const e of avail){
    if(!byD[e.department])byD[e.department]=[];
    byD[e.department].push(e);
  }
  for(const dept of Object.keys(byD)){
    const og=document.createElement('optgroup');
    og.label=dept;
    for(const e of byD[dept]){
      const o=document.createElement('option');
      o.value=e.id;o.textContent=empLabel(e);
      if(e.id===M.speEmpId)o.selected=true;
      og.appendChild(o);
    }
    s.appendChild(og);
  }
}

function buildRepSel(){
  const n=S.nodes[M.nodeId];
  if(n&&n.isRoot)return;
  const s=document.getElementById('s-rep');
  s.innerHTML='<option value="">— Select Reporting Person —</option>';
  const curIds=new Set(M.mode==='designation'?M.selEmps:(M.speEmpId?[M.speEmpId]:[]));
  const opts=orgEmps(M.nodeId);
  // group by node/dept for readability
  const seen=new Set();
  for(const e of opts){
    if(curIds.has(e.id)||seen.has(e.id))continue;
    seen.add(e.id);
    const o=document.createElement('option');
    o.value=e.id;
    o.textContent=`${empLabel(e)} · ${e.department}`;
    if(e.id===M.repEmpId)o.selected=true;
    s.appendChild(o);
  }
}

/* ── Form event handlers ── */
window.onDeptChange=function(){
  M.dept=document.getElementById('s-dept').value;
  M.desig='';M.selEmps=[];
  buildDesigSel();buildEmpBox();buildRepSel();validate();
};
window.onDesigChange=function(){
  M.desig=document.getElementById('s-desig').value;
  M.selEmps=[];buildEmpBox();buildRepSel();validate();
};
window.toggleAll=function(checked){
  const taken=new Set(orgEmps(M.nodeId).map(e=>e.id));
  const avail=empsByDesig(M.dept,M.desig).filter(e=>!taken.has(e.id));
  M.selEmps=checked?avail.map(e=>e.id):[];
  buildEmpBox();buildRepSel();validate();
};
window.toggleEmp=function(id,checked){
  if(checked){if(!M.selEmps.includes(id))M.selEmps.push(id);}
  else M.selEmps=M.selEmps.filter(x=>x!==id);
  // update "all" checkbox
  const taken=new Set(orgEmps(M.nodeId).map(e=>e.id));
  const avail=empsByDesig(M.dept,M.desig).filter(e=>!taken.has(e.id));
  const ck=document.getElementById('chk-all');
  if(ck)ck.checked=M.selEmps.length===avail.length&&avail.length>0;
  buildRepSel();validate();
};
window.onSpeEmpChange=function(){
  M.speEmpId=document.getElementById('s-emp-spe').value;
  const e=empById(M.speEmpId);
  if(e){
    document.getElementById('spe-detail').style.display='';
    document.getElementById('spe-dept').textContent=e.department;
    document.getElementById('spe-desig').textContent=e.designation;
    M.dept=e.department;M.desig=e.designation;
  }else{
    document.getElementById('spe-detail').style.display='none';
  }
  buildRepSel();validate();
};
window.onRepChange=function(){
  M.repEmpId=document.getElementById('s-rep').value;
  validate();
};

/* ── Validation ── */
function validate(){
  const n=S.nodes[M.nodeId];
  const isRoot=n&&n.isRoot;
  const msg=document.getElementById('v-msg');
  const save=document.getElementById('modal-save');
  msg.className='v-msg';msg.textContent='';

  const desMode=M.mode==='designation';
  if(desMode){
    if(!M.dept||!M.desig||!M.selEmps.length){save.disabled=true;return;}
  }else{
    if(!M.speEmpId){save.disabled=true;return;}
  }
  if(!isRoot&&!M.repEmpId){save.disabled=true;return;}

  if(!isRoot){
    const selIds=desMode?M.selEmps:[M.speEmpId];
    // Self-report
    if(selIds.includes(M.repEmpId)){
      msg.className='v-msg err';msg.textContent='An employee cannot report to themselves.';
      save.disabled=true;return;
    }
    // Reporter is descendant of current node → circular
    const repNode=nodeOfEmp(M.repEmpId);
    if(repNode&&isDescendantOf(repNode.id,M.nodeId)){
      msg.className='v-msg err';msg.textContent='Circular hierarchy: the selected reporter is a descendant of this node.';
      save.disabled=true;return;
    }
    // Reporting to own child (child node check)
    if(repNode&&isAncestorOf(M.nodeId,repNode.id)){
      msg.className='v-msg err';
      msg.textContent='Cannot report to a node that reports (directly or indirectly) to this node — this would create a circular structure.';
      save.disabled=true;return;
    }
  }

  save.disabled=false;
}

/* ── Save ── */
window.saveNode=function(){
  const n=S.nodes[M.nodeId];if(!n)return;
  let emps=[];
  if(M.mode==='designation'){
    emps=M.selEmps.map(id=>empById(id)).filter(Boolean);
    n.department=M.dept;n.designation=M.desig;
  }else{
    const e=empById(M.speEmpId);
    if(!e)return;
    emps=[e];n.department=e.department;n.designation=e.designation;
  }
  n.employees=emps;

  if(!n.isRoot){
    const repEmp=empById(M.repEmpId);
    if(repEmp){
      const repNode=nodeOfEmp(M.repEmpId);
      if(repNode&&repNode.id!==n.reportingTo){
        // Detach from old parent
        if(n.reportingTo){
          const old=S.nodes[n.reportingTo];
          if(old)old.children=old.children.filter(x=>x!==n.id);
        }
        // Attach to new parent
        if(!repNode.children.includes(n.id))repNode.children.push(n.id);
        n.reportingTo=repNode.id;
      }else if(!n.reportingTo&&repNode){
        repNode.children.push(n.id);
        n.reportingTo=repNode.id;
      }
    }
  }

  document.getElementById('modal-bg').classList.remove('open');
  render();
};

/* ═══════════════════════════════════════════════════════════
   ZOOM
═══════════════════════════════════════════════════════════ */
let zoom=1;
function setZoom(z){
  zoom=Math.min(2,Math.max(.25,z));
  document.getElementById('chart-inner').style.transform=`scale(${zoom})`;
  document.getElementById('z-pct').textContent=Math.round(zoom*100)+'%';
}
function fitView(){
  const wrap=document.getElementById('canvas-wrap');
  const inner=document.getElementById('chart-inner');
  const iw=parseInt(inner.style.width)||800;
  const z=Math.min(1,(wrap.clientWidth-40)/iw);
  setZoom(z);
  wrap.scrollTo(0,0);
}

document.getElementById('z-in').onclick=()=>setZoom(zoom+.1);
document.getElementById('z-out').onclick=()=>setZoom(zoom-.1);
document.getElementById('canvas-wrap').addEventListener('wheel',e=>{
  if(e.ctrlKey){e.preventDefault();setZoom(zoom-e.deltaY*.001);}
},{passive:false});

/* ═══════════════════════════════════════════════════════════
   TOOLBAR BUTTONS
═══════════════════════════════════════════════════════════ */
document.getElementById('btn-reset').onclick=()=>{
  if(!confirm('Reset the organogram? All data will be lost.'))return;
  initRoot();render();setZoom(1);
};
document.getElementById('btn-expand').onclick=()=>{S.collapsed.clear();render();};
document.getElementById('btn-collapse').onclick=()=>{
  Object.keys(S.nodes).forEach(id=>{if(id!==S.rootId)S.collapsed.add(id);});
  render();
};
document.getElementById('btn-fit').onclick=()=>setTimeout(fitView,50);

/* ── Modal close helpers ── */
document.getElementById('modal-x').onclick=closeModal;
document.getElementById('modal-bg').addEventListener('click',e=>{
  if(e.target===document.getElementById('modal-bg'))closeModal();
});
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closeModal();closeConfirm();}
});

/* ═══════════════════════════════════════════════════════════
   INIT
═══════════════════════════════════════════════════════════ */
initRoot();
render();
setTimeout(fitView,120);
</script>
</body>
</html>
